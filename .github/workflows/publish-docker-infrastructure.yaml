name: Reusable docker image publish from infrastructure

on:
  workflow_call:
    secrets:
      sshPrivateKey:
        required: true
      token:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Login Docker registry
        env:
          REPOSITORY_OWNER: ${{ github.repository_owner }}
          TOKEN: ${{ secrets.token }}
        run: |
          echo $TOKEN | docker login ghcr.io -u $REPOSITORY_OWNER --password-stdin

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Detect changed images
        id: filter
        uses: dorny/paths-filter@v3
        with:
          list-files: shell
          filters: |
            images:
              - added|modified: 'images/**'

      - name: Collect changed image dirs
        id: collect_dirs
        if: steps.filter.outputs.images == 'true'
        run: |
          if [ -z "${{ steps.filter.outputs.images_files }}" ]; then
            echo "dirs=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          CHANGED_DIRS=$(
            for f in ${{ steps.filter.outputs.images_files }}; do
              d=$(dirname "$f")
              case "$d" in
                images/*)
                  echo "$d" | cut -d'/' -f1-2
                  ;;
              esac
            done | sort -u
          )

          echo "Changed dirs:"
          echo "$CHANGED_DIRS"

          echo "dirs=$CHANGED_DIRS" >> "$GITHUB_OUTPUT"

      - name: Build changed images
        if: steps.collect_dirs.outputs.dirs != ''
        env:
          CHANGED_DIRS: ${{ steps.collect_dirs.outputs.dirs }}
          REPOSITORY_OWNER: ${{ github.repository_owner }}
          PRIVATE_KEY: ${{ secrets.sshPrivateKey }}
        run: |
          REPOSITORY_OWNER_CLEAN=$(echo "$REPOSITORY_OWNER" | tr '[:upper:]' '[:lower:]')

          for DIR in $CHANGED_DIRS; do
            DOCKERFILE="$DIR/Dockerfile"
            if [ ! -f "$DOCKERFILE" ]; then
              echo "Skip $DIR: no Dockerfile"
              continue
            fi

            NAME=$(basename "$DIR")
            IMAGE_BASE="ghcr.io/${REPOSITORY_OWNER_CLEAN}/${NAME}"
            IMAGE_LATEST="$IMAGE_BASE:latest"
            IMAGE_HASH="$IMAGE_BASE:$(git rev-parse --short HEAD)-$(date +%s)"

            echo "Building image $IMAGE_LATEST from $DIR"

            docker buildx build \
              --platform linux/amd64 \
              --build-arg SSH_PRIVATE_KEY="$PRIVATE_KEY" \
              --cache-from type=gha,scope="$NAME" \
              --cache-to type=gha,mode=max,scope="$NAME" \
              --push \
              --progress plain \
              -t "$IMAGE_LATEST" \
              -t "$IMAGE_HASH" \
              "$DIR"
          done
