name: Check issues

on:
  workflow_call:
    inputs:
      app-id:
        type: string
        required: true
    secrets:
      app-private-key:
        required: true

jobs:
  run:
    name: Check issue dates
    runs-on: ubuntu-latest

    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ inputs.app-id }}
          private-key: ${{ secrets.app-private-key }}
          owner: ${{ github.repository_owner }}

      - name: Fetch closed issues for last 14 days
        id: closed_tasks
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const sinceDate = new Date(Date.now() - 14 * 24 * 60 * 60 * 1000);
            const since = sinceDate.toISOString().slice(0, 10); // YYYY-MM-DD

            const q = [
              `repo:${context.repo.owner}/${context.repo.repo}`,
              'is:issue',
              'is:closed',
              `closed:>=${since}`
            ].join(' ');

            const items = await github.paginate(github.rest.search.issuesAndPullRequests, {
              q,
              per_page: 100,
            });

            // Normalize fields
            const issues = items.map(i => ({
              number: i.number,
              title: i.title,
              url: i.html_url,
              closed_at: i.closed_at,
              assignees: i.assignees?.map(a => a.login) ?? [],
              labels: i.labels?.map(l => typeof l === 'string' ? l : l.name).filter(Boolean) ?? [],
              author: i.user?.login ?? null,
            }));

            const rows = [
              [{data: '№', header: true}, {data: 'Title', header: true}, {data: 'Closed At', header: true}]
            ].concat(
              issues.map(i => [
                `#${i.number}`,
                `<a href="${i.url}">${i.title}</a>`,
                new Date(i.closed_at).toISOString()
              ])
            );

            await core.summary
              .addHeading(`Closed issues for last 14 days (${issues.length})`)
              .addTable(rows)
              .write();

            core.setOutput('issues', JSON.stringify(issues, null, 2));

      - name: Fetch members of team dsm
        id: team_dsm
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const org = context.repo.owner;
            const target = 'dsm';

            const teams = await github.paginate(github.rest.teams.list, {
              org,
              per_page: 100,
            });

            const team =
              teams.find(t => t.slug.toLowerCase() === target) ||
              teams.find(t => t.name.toLowerCase() === target);

            if (!team) {
              core.setFailed(`Team not found. Available team slugs: ${teams.map(t => t.slug).join(', ')}`);
              return;
            }

            const members = await github.paginate(
              github.rest.teams.listMembersInOrg,
              { org, team_slug: team.slug, per_page: 100 }
            );

            const logins = members.map(m => m.login);
            core.info(`Team ${team.slug} members: ${logins.join(', ')}`);
            core.setOutput('members', JSON.stringify(logins));

      - name: Check DSM comments on issues
        id: check_dsm_comments
        uses: actions/github-script@v7
        env:
          ISSUES: ${{ steps.closed_tasks.outputs.issues }}
          DSM_MEMBERS: ${{ steps.team_dsm.outputs.members }}
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const issues = JSON.parse(process.env.ISSUES || '[]');
            const dsm = new Set(JSON.parse(process.env.DSM_MEMBERS || '[]').map(s => s.toLowerCase()));

            /** Collect missing comments: { member -> [{issue_number, title, url, closed_at}] } */
            const missingByMember = new Map([...dsm].map(m => [m, []]));

            for (const issue of issues) {
              const comments = await github.paginate(github.rest.issues.listComments, {
                owner, repo, issue_number: issue.number, per_page: 100,
              });

              const commenters = new Set(
                comments
                  .map(c => c.user?.login?.toLowerCase())
                  .filter(Boolean)
              );

              for (const member of dsm) {
                if (!commenters.has(member)) {
                  missingByMember.get(member).push({
                    issue_number: issue.number,
                    title: issue.title,
                    url: issue.url,
                    closed_at: issue.closed_at
                  });
                }
              }
            }

            // Build summary table: Member | Missing Count | Details
            const table = [
              [
                { data: 'Member', header: true },
                { data: 'Missing count', header: true },
                { data: 'Details', header: true }
              ]
            ];

            for (const [member, list] of missingByMember.entries()) {
              const details = list.length
                ? list.map(i => `#${i.issue_number} <a href="${i.url}">${i.title}</a> — closed ${new Date(i.closed_at).toISOString()}`).join('<br/>')
                : '—';
              table.push([member, String(list.length), details]);
            }

            await core.summary
              .addHeading('DSM members without comments on closed issues (last 14 days)')
              .addTable(table)
              .write();

            core.setOutput('missing', JSON.stringify(Object.fromEntries(missingByMember)));
